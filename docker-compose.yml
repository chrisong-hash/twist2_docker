services:
  twist2:
    build:
      context: .
      dockerfile: Dockerfile
    image: twist2_ig
    container_name: twist2

    # GPU configuration (works with both nvidia runtime and nvidia-container-toolkit)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility, graphics]
    
    environment:
      - DISPLAY=${DISPLAY}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all

    network_mode: host
    ipc: host

    volumes:
      # X11 access
      - /tmp/.X11-unix:/tmp/.X11-unix:rw

      # Project mounts (essential)
      - ./isaacgym:/opt/isaacgym:ro
      - ./twist2:/workspace/twist2
      - ./unitree_sdk2:/workspace/unitree_sdk2
      - ./GMR:/workspace/GMR
      
      # RoboMimic for hybrid locomotion
      - /home/robo/CodeSpace/RoboMimic_Deploy:/workspace/RoboMimic_Deploy:ro

    tty: true
    stdin_open: true

    entrypoint: /bin/bash
    command: -c "redis-server --daemonize yes && source /opt/miniconda3/etc/profile.d/conda.sh && conda activate twist2 && tail -f /dev/null"

