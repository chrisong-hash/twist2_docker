services:
  twist2:
    build:
      context: .
      dockerfile: Dockerfile
    image: twist2_ig
    container_name: twist2

    runtime: nvidia
    environment:
      - DISPLAY=${DISPLAY}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      # PulseAudio for voice recognition
      - PULSE_SERVER=unix:${XDG_RUNTIME_DIR:-/run/user/1000}/pulse/native
      # Force PulseAudio over ALSA to avoid assertion failures
      - SDL_AUDIODRIVER=pulseaudio
      - AUDIODEV=pulse

    network_mode: host
    ipc: host

    volumes:
      # X11 access
      - /tmp/.X11-unix:/tmp/.X11-unix:rw

      # Project mounts
      - ./isaacgym:/opt/isaacgym
      - ./twist2:/workspace/twist2
      - ./unitree_sdk2:/workspace/unitree_sdk2
      - ./GMR:/workspace/GMR

      # Vulkan ICD + Implicit layers (read-only OK)
      - /usr/share/vulkan/icd.d:/usr/share/vulkan/icd.d:ro
      - /usr/share/vulkan/implicit_layer.d:/usr/share/vulkan/implicit_layer.d:ro

      # Audio: PulseAudio socket and cookie for microphone access
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/pulse/native:${XDG_RUNTIME_DIR:-/run/user/1000}/pulse/native
      - ~/.config/pulse/cookie:/root/.config/pulse/cookie:ro

      # ‚ùå REMOVE THIS (it broke the container)
      # - /usr/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:ro

    # Audio device access (ALSA)
    devices:
      - /dev/snd:/dev/snd

    tty: true
    stdin_open: true

    entrypoint: /bin/bash
    command: -c "redis-server --daemonize yes && source /opt/miniconda3/etc/profile.d/conda.sh && conda activate twist2 && tail -f /dev/null"

